<div id="comments-list">
    <style>
        .nickname-style {
            background-color: #2b2b2b;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid #444;
            font-weight: normal;
        }
    </style>

    {{#commentDtos}}
        <div class="card m-3" id="comments-{{id}}" style="background-color: #1e1e1e; color: white; border: 1px solid #444;">
            <div class="card-header d-flex justify-content-between align-items-center" style="background-color: #2a2a2a; color: white; border-bottom: 1px solid #444;">
                <span class="nickname-style">{{nickname}}</span>
                <div>
                    <!-- Button trigger modal -->
                    <button type="button" class="btn btn-sm btn-outline-primary me-2"
                            data-bs-toggle="modal"
                            data-bs-target="#comment-edit-modal"
                            data-bs-id="{{id}}"
                            data-bs-nickname="{{nickname}}"
                            data-bs-body="{{body}}"
                            data-bs-movie-id="{{movieId}}">
                        Update
                    </button>

                    <button type="button" class="btn btn-sm btn-outline-danger comment-delete-btn"
                            data-comment-id="{{id}}"
                            data-movie-id="{{movieId}}"
                            data-table-number="3">Delete</button>
                </div>

                <!-- Modal -->
                <div class="modal fade" id="comment-edit-modal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content" style="background-color: #1e1e1e; color: white;">
                            <div class="modal-header" style="border-bottom: 1px solid #444;">
                                <h5 class="modal-title w-100 text-center" id="exampleModalLabel" style="color: white;">Edit Comment</h5>
                                <button type="button"
                                        class="btn-close btn-close-white"
                                        data-bs-dismiss="modal"
                                        aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <form>
                                    <style>
                                        .dark-modal-label {
                                            color: white;
                                        }
                                        .dark-input {
                                            background-color: #333;
                                            color: white;
                                            border: 1px solid #555;
                                        }
                                    </style>
                                    <div class="mb-3">
                                        <label class="form-label dark-modal-label">Nickname</label>
                                        <input type="text" class="form-control dark-input" id="edit-comment-nickname" />
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label dark-modal-label">Comment body</label>
                                        <textarea class="form-control dark-input" rows="3" id="edit-comment-body"></textarea>
                                    </div>

                                    <input type="hidden" id="edit-comment-movie-id" />
                                    <input type="hidden" id="edit-comment-id" />

                                    <button type="button" class="btn btn-primary w-100" id="comment-update-btn">Update Success</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <div class="card-body" style="border-top: 1px solid #444;">
                {{body}}
            </div>
        </div>
    {{/commentDtos}}
</div>

<script>
    {
        const commentEditModal = document.querySelector("#comment-edit-modal");
        commentEditModal.addEventListener("show.bs.modal", function(event){
            const triggerBtn = event.relatedTarget;
            const id = triggerBtn.getAttribute("data-bs-id");
            const nickname = triggerBtn.getAttribute("data-bs-nickname");
            const body = triggerBtn.getAttribute("data-bs-body");
            const movieId = triggerBtn.getAttribute("data-bs-movie-id");

            document.querySelector("#edit-comment-nickname").value = nickname;
            document.querySelector("#edit-comment-body").value = body;
            document.querySelector("#edit-comment-id").value = id;
            document.querySelector("#edit-comment-movie-id").value = movieId;
        });
    }

    {
        const commentUpdateBtn = document.querySelector("#comment-update-btn");
        commentUpdateBtn.addEventListener("click", function(){
            const comment = {
                id: document.querySelector("#edit-comment-id").value,
                nickname: document.querySelector("#edit-comment-nickname").value,
                body: document.querySelector("#edit-comment-body").value,
                movie_id: document.querySelector("#edit-comment-movie-id").value
            };

            const movieId = comment.movie_id;
            const url = `/api/comments/1/${movieId}`;
            fetch(url, {
                method: "PATCH",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(comment)
            }).then(response => {
                const msg = (response.ok) ? "댓글 수정 성공!" : "댓글 수정 실패!";
                alert(msg);
                window.location.reload();
            });
        });
    }

    {
        const commentDeleteBtns = document.querySelectorAll(".comment-delete-btn");
        commentDeleteBtns.forEach(btn => {
            btn.addEventListener("click", (event) => {
                const commentDeleteBtn = event.target;
                const commentId = commentDeleteBtn.getAttribute("data-comment-id");

                const url = `/api/comments/1/${commentId}`;
                fetch(url, {
                    method: "DELETE"
                }).then(response => {
                    if (!response.ok) {
                        alert("댓글 삭제에 실패하였습니다");
                        return;
                    }
                    const msg = `${commentId}번 댓글 삭제에 성공하였습니다`;
                    alert(msg);
                    window.location.reload();
                });
            });
        });
    }
</script>
